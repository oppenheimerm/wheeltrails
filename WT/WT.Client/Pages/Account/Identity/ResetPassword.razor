@inject IAccountService AccountService
@inject NavigationManager NavigationManager

@using Microsoft.AspNetCore.Components.Authorization
@using System.Linq.Expressions

@page "/account/identity/reset-password"

<PageTitle>WheelyTrails - Reset Password</PageTitle>

@code {
    [SupplyParameterFromQuery(Name = "token")]
    public string? Token { get; set; }

    [SupplyParameterFromQuery(Name = "email")]
    public string? Email { get; set; }

    private ResetPasswordDTO ModelDTO { get; set; } = new();
    private EditContext? editContext;

    private bool isSubmitting = false;
    private string? errorMessage;
    private string? successMessage;
    private bool showPassword = false;
    private bool showConfirmPassword = false;

    protected override void OnInitialized()
    {
        // Pre-populate email and token from query parameters
        if (!string.IsNullOrEmpty(Email))
        {
            ModelDTO.Email = Uri.UnescapeDataString(Email);
        }

        if (!string.IsNullOrEmpty(Token))
        {
            ModelDTO.Token = Uri.UnescapeDataString(Token);
        }

        editContext = new EditContext(ModelDTO);
        Console.WriteLine($"Reset Password page initialized. Token present: {!string.IsNullOrEmpty(Token)}, Email: {Email}");
    }

    private async Task HandleValidSubmit()
    {
        Console.WriteLine("✅ HandleValidSubmit CALLED!");
        Console.WriteLine($"Email: {ModelDTO.Email}");
        Console.WriteLine($"Token length: {ModelDTO.Token?.Length ?? 0}");

        if (isSubmitting) return;

        // Validate token presence
        if (string.IsNullOrEmpty(ModelDTO.Token))
        {
            errorMessage = "Reset token is missing. Please use the link from your email.";
            return;
        }

        try
        {
            isSubmitting = true;
            errorMessage = null;
            successMessage = null;
            StateHasChanged();

            var response = await AccountService.ResetPasswordAsync(ModelDTO);

            Console.WriteLine($"Response received. Success: {response.Success}");

            if (response.Success)
            {
                Console.WriteLine("🎉 Password reset successful!");
                successMessage = response.Message;

                // Clear sensitive data
                ModelDTO.NewPassword = string.Empty;
                ModelDTO.ConfirmPassword = string.Empty;
            }
            else
            {
                errorMessage = response.Message;
                Console.WriteLine($"Password reset failed: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Exception: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void HandleInvalidSubmit()
    {
        Console.WriteLine("❌ HandleInvalidSubmit called - form has validation errors");

        if (editContext != null)
        {
            var errors = editContext.GetValidationMessages();
            foreach (var error in errors)
            {
                Console.WriteLine($"  - {error}");
            }
        }
    }

    private bool HasValidationErrors(Expression<Func<string?>> accessor)
    {
        if (editContext == null) return false;

        var fieldIdentifier = FieldIdentifier.Create(accessor);
        return editContext.GetValidationMessages(fieldIdentifier).Any();
    }

    private string GetInputClass(Expression<Func<string?>> accessor)
    {
        return HasValidationErrors(accessor) ? "wt-form-input-error" : "wt-form-input";
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        showConfirmPassword = !showConfirmPassword;
    }

    private void NavigateToLogin()
    {
        NavigationManager.NavigateTo("/account/identity/login", forceLoad: false);
    }
}

<div class="mt-[96.8px]">
    <div class="grid lg:grid-cols-2 md:grid-cols-2 items-center gap-4 bg-harp-200 dark:bg-harp-950">
        <!--lhs side background image -->
        <div class="max-md:order-1 h-screen min-h-full">
            <img src="https://readymadeui.com/image-3.webp" class="w-full h-full object-cover" alt="reset-password-image" />
        </div>

        <!-- rhs form-->
        <div class="max-w-xl w-full p-6 mx-auto text-wt-black-950 dark:text-white">
            @if (string.IsNullOrEmpty(Token))
            {
                <!-- Missing Token Error State -->
                <div class="mb-8">
                    <div class="p-4 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-lg">
                        <div class="flex items-start">
                            <span class="material-symbols-rounded text-[24px] mr-3">
                                error
                            </span>
                            <div>
                                <h3 class="font-semibold mb-2">Invalid Reset Link</h3>
                                <p class="text-sm">This password reset link is invalid or has expired. Please request a new password reset.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center space-y-4">
                    <a href="/account/identity/forgot-password"
                       class="inline-block w-full py-2 px-4 text-[15px] font-medium tracking-wide rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none cursor-pointer">
                        Request New Reset Link
                    </a>
                    <a href="/account/identity/login"
                       class="inline-block w-full py-2 px-4 text-[15px] font-medium tracking-wide rounded-md text-slate-700 dark:text-white bg-white dark:bg-harp-800 border border-slate-300 dark:border-harp-600 hover:bg-slate-50 dark:hover:bg-harp-700 focus:outline-none cursor-pointer">
                        Back to Login
                    </a>
                </div>
            }
            else
            {
                <EditForm OnValidSubmit="HandleValidSubmit"
                          OnInvalidSubmit="HandleInvalidSubmit"
                          EditContext="editContext">
                    <DataAnnotationsValidator />

                    <!-- Error Display -->
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="mb-4 p-3 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded">
                            <div class="flex items-start">
                                <span class="material-symbols-rounded text-[20px] mr-2">
                                    error
                                </span>
                                <span>@errorMessage</span>
                            </div>
                        </div>
                    }

                    <!-- Success Display -->
                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="mb-4 p-3 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded">
                            <div class="flex items-start">
                                <span class="material-symbols-rounded text-[20px] mr-2">
                                    check_circle
                                </span>
                                <span>@successMessage</span>
                            </div>
                        </div>
                    }

                    <div class="mb-12">
                        <h1 class="text-4xl font-bold text-wt-black-900 dark:text-white">Reset Password</h1>
                        <p class="text-base mt-6 font-medium text-slate-600 dark:text-slate-300">
                            Enter your new password below. Make sure it's at least 7 characters long.
                        </p>
                    </div>

                    @if (string.IsNullOrEmpty(successMessage))
                    {
                        <div class="space-y-6">
                            <!-- Email (read-only) -->
                            <div>
                                <label class="wt-form-lbl" for="email">Email</label>
                                <div class="relative flex items-center">
                                    <InputText @bind-Value="ModelDTO.Email"
                                               id="email"
                                               readonly
                                               class="wt-form-input bg-slate-100 dark:bg-harp-800 cursor-not-allowed"
                                               placeholder="Email address" />

                                    <!-- icon wrap -->
                                    <div class="w-[18px] h-[18px] absolute right-2 pointer-events-none">
                                        <span class="material-symbols-rounded text-[18px]">
                                            mail
                                        </span>
                                    </div>
                                </div>
                                <ValidationMessage For="@(() => ModelDTO.Email)" class="wt-form-error-msg" />
                            </div>

                            <!-- Hidden Token Field -->
                            <InputText @bind-Value="ModelDTO.Token" type="hidden" />

                            <!-- New Password -->
                            <div>
                                <label class="wt-form-lbl" for="newPassword">New Password</label>
                                <div class="relative flex items-center">
                                    <InputText @bind-Value="ModelDTO.NewPassword"
                                               type="@(showPassword ? "text" : "password")"
                                               id="newPassword"
                                               class="@GetInputClass(() => ModelDTO.NewPassword)"
                                               placeholder="Enter new password (min 7 characters)" />

                                    <!-- Toggle visibility icon -->
                                    <button type="button"
                                            @onclick="TogglePasswordVisibility"
                                            class="w-[18px] h-[18px] absolute right-2 cursor-pointer focus:outline-none hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                                        <span class="material-symbols-rounded text-[18px]">
                                            @(showPassword ? "visibility_off" : "visibility")
                                        </span>
                                    </button>
                                </div>
                                <ValidationMessage For="@(() => ModelDTO.NewPassword)" class="wt-form-error-msg" />

                                <!-- Password strength indicator -->
                                @if (!string.IsNullOrEmpty(ModelDTO.NewPassword))
                                {
                                    <div class="mt-2">
                                        <div class="flex items-center gap-2 text-xs">
                                            @if (ModelDTO.NewPassword.Length >= 7)
                                            {
                                                <span class="text-green-600 dark:text-green-400 flex items-center">
                                                    <span class="material-symbols-rounded text-[14px] mr-1">check_circle</span>
                                                    Minimum length met
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-amber-600 dark:text-amber-400 flex items-center">
                                                    <span class="material-symbols-rounded text-[14px] mr-1">info</span>
                                                    Need @(7 - ModelDTO.NewPassword.Length) more character(s)
                                                </span>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Confirm Password -->
                            <div>
                                <label class="wt-form-lbl" for="confirmPassword">Confirm New Password</label>
                                <div class="relative flex items-center">
                                    <InputText @bind-Value="ModelDTO.ConfirmPassword"
                                               type="@(showConfirmPassword ? "text" : "password")"
                                               id="confirmPassword"
                                               class="@GetInputClass(() => ModelDTO.ConfirmPassword)"
                                               placeholder="Confirm new password" />

                                    <!-- Toggle visibility icon -->
                                    <button type="button"
                                            @onclick="ToggleConfirmPasswordVisibility"
                                            class="w-[18px] h-[18px] absolute right-2 cursor-pointer focus:outline-none hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                                        <span class="material-symbols-rounded text-[18px]">
                                            @(showConfirmPassword ? "visibility_off" : "visibility")
                                        </span>
                                    </button>
                                </div>
                                <ValidationMessage For="@(() => ModelDTO.ConfirmPassword)" class="wt-form-error-msg" />

                                <!-- Password match indicator -->
                                @if (!string.IsNullOrEmpty(ModelDTO.NewPassword) && !string.IsNullOrEmpty(ModelDTO.ConfirmPassword))
                                {
                                    <div class="mt-2">
                                        @if (ModelDTO.NewPassword == ModelDTO.ConfirmPassword)
                                        {
                                            <span class="text-xs text-green-600 dark:text-green-400 flex items-center">
                                                <span class="material-symbols-rounded text-[14px] mr-1">check_circle</span>
                                                Passwords match
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-xs text-red-600 dark:text-red-400 flex items-center">
                                                <span class="material-symbols-rounded text-[14px] mr-1">cancel</span>
                                                Passwords do not match
                                            </span>
                                        }
                                    </div>
                                }
                            </div>

                            <!-- Password Requirements Info -->
                            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                                <div class="flex items-start">
                                    <span class="material-symbols-rounded text-[20px] text-blue-600 dark:text-blue-400 mr-2">
                                        info
                                    </span>
                                    <div class="text-sm text-blue-800 dark:text-blue-200">
                                        <p class="font-semibold mb-1">Password Requirements:</p>
                                        <ul class="list-disc list-inside space-y-1 text-xs">
                                            <li>At least 7 characters long</li>
                                            <li>Consider using a mix of letters, numbers, and symbols for better security</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-12">
                            <button type="submit"
                                    class="w-full py-2 px-4 text-[15px] font-medium tracking-wide rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                                    disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="flex items-center justify-center">
                                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        Resetting Password...
                                    </span>
                                }
                                else
                                {
                                    <span>Reset Password</span>
                                }
                            </button>
                        </div>

                        <div class="mt-6 text-center">
                            <p class="text-sm text-slate-900 dark:text-white">
                                Remember your password? <a href="/account/identity/login" class="wt-link">Sign in here</a>
                            </p>
                        </div>
                    }
                    else
                    {
                        <!-- Success State - Show Login Button -->
                        <div class="mt-8 space-y-4">
                            <div class="text-center">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full mb-4">
                                    <span class="material-symbols-rounded text-[40px] text-green-600 dark:text-green-400">
                                        check_circle
                                    </span>
                                </div>
                                <h2 class="text-2xl font-bold text-wt-black-900 dark:text-white mb-2">Password Reset Successful!</h2>
                                <p class="text-slate-600 dark:text-slate-300 mb-6">
                                    Your password has been successfully reset. You can now log in with your new password.
                                </p>
                            </div>

                            <button type="button"
                                    @onclick="NavigateToLogin"
                                    class="w-full py-2 px-4 text-[15px] font-medium tracking-wide rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none cursor-pointer transition-colors">
                                Continue to Login
                            </button>
                        </div>
                    }

                </EditForm>
            }
        </div>
    </div>
</div>
